<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Pair Cute Animal Pictures</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- KETERANGAN: Menambahkan library html2canvas untuk fitur screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      /* --- General Styles --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        position: fixed;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        background: url("bg/bg1.png");
        background-size: cover;
        background-position: center;
        color: white;
        font-family: Arial, sans-serif;
        font-size: 16px;
        touch-action: manipulation;
        transition: background 0.5s ease;
      }

      .game-wrapper {
        width: 100%;
        max-width: 480px;
        height: 100%;
        color: white;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .btn {
        padding: 10px 18px;
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        user-select: none;
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.5);
      }
      .btn-confirm-yes {
        background: #4caf50;
      }
      .btn-confirm-no {
        background: #f44336;
      }
      /* KETERANGAN: Style untuk tombol bagikan */
      .btn-share {
        background: #00bcd4;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      /* --- Start Screen & Modals --- */
      .overlay-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none; /* Defaultnya disembunyikan */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 100;
        padding: 20px;
        overflow-y: auto;
      }

      #start-screen {
        display: flex;
      }

      /* Kode Baru */
      .start-screen-content,
      .modal-content {
        background: rgba(25, 25, 25, 0.8);
        padding: 30px 40px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid #fc813f;
        position: relative;
        max-width: 90%;
        width: 100%;
        box-sizing: border-box;
        max-height: 80vh; /* TAMBAHKAN: Batasi tinggi maksimal 80% dari layar */
        overflow-y: auto; /* TAMBAHKAN: Tampilkan scrollbar jika konten lebih tinggi */
      }

      .start-screen-content h1 {
        color: #f6fc3f;
        font-family: "Times New Roman", Times, serif;
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .start-screen-content p {
        font-size: 1.2rem;
        margin-bottom: 30px;
      }

      .start-buttons,
      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .modal-content h2 {
        color: #f6fc3f;
        margin-bottom: 15px;
      }
      .modal-content p {
        line-height: 1.6;
        margin-bottom: 25px;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
      }
      .modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 2rem;
        color: white;
        cursor: pointer;
      }

      #fact-text {
        font-style: italic;
        color: #f0f0f0;
        min-height: 100px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* --- Game Container --- */
      .container {
        display: none;
        flex-direction: column;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.5);
        height: 100%;
        overflow-y: auto;
        width: 100%;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        margin-top: 0;
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
      }

      .game-stats {
        display: flex;
        align-items: center;
        gap: 15px;
        order: 2;
        flex-grow: 1;
        justify-content: center;
      }

      .sound-controls {
        display: flex;
        align-items: center;
        gap: 6px;
        order: 1;
      }

      .game-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
        order: 3;
      }

      #level-display,
      .score-display {
        font-size: 1.2rem;
      }

      .game-buttons .btn,
      .sound-controls .btn {
        font-size: 22px;
      }

      .judul {
        text-align: center;
        color: #f6fc3f;
        font-size: 18px;
        font-family: "Times New Roman", Times, serif;
        margin-top: 2%;
        width: 100%;
      }

      .time {
        font-size: 1.2rem;
        font-weight: bold;
        color: #f6fc3f;
        background: none;
        border: none;
        padding: 0;
        order: -1;
      }

      .grid-container {
        padding: 5px;
        width: 100%;
        flex-grow: 1;
        margin-top: -5px;
      }

      .grid-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }

      .grid-item {
        position: relative;
        float: left;
        height: 100%;
        border-radius: 5px;
        margin: 2px;
      }

      .grid-item > div {
        width: 100%;
        height: 100%;
      }

      .grid-item.action .grid-item-content {
        background: #fc813f;
        transform: scale(1.1);
      }
      .grid-item.hidden .grid-item-content {
        opacity: 0;
        transform: scale(0);
      }

      .grid-item-content {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1px;
        font-size: 12px;
        transition: all 0.3s ease;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.1);
      }

      .grid-item-content img {
        width: 38px;
        height: 38px;
        cursor: pointer;
        user-select: none;
        -webkit-user-drag: none;
      }

      .grid-item-direction {
        position: absolute;
        pointer-events: none;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      .grid-item-direction > div {
        position: absolute;
        background: #fc813f;
        opacity: 0;
      }
      .grid-item-direction.up > div.y,
      .grid-item-direction.down > div.y {
        margin: 0 auto;
        left: 0;
        right: 0;
        width: 3px;
        height: 50%;
      }
      .grid-item-direction.left > div.x,
      .grid-item-direction.right > div.x {
        margin: auto 0;
        top: 0;
        bottom: 0;
        width: 50%;
        height: 3px;
      }
      .grid-item-direction.up > div.up {
        top: 0;
        opacity: 1;
        animation: height 0.2s ease;
      }
      .grid-item-direction.down > div.down {
        bottom: 0;
        opacity: 1;
        animation: height 0.2s ease;
      }
      .grid-item-direction.left > div.left {
        left: 0;
        opacity: 1;
        animation: width 0.2s ease;
      }
      .grid-item-direction.right > div.right {
        right: 0;
        opacity: 1;
        animation: width 0.2s ease;
      }

      @keyframes height {
        0% {
          height: 0;
        }
        100% {
          height: 50%;
        }
      }
      @keyframes width {
        0% {
          width: 0;
        }
        100% {
          width: 50%;
        }
      }

      .icon-btn {
        font-size: 1.5rem;
        color: white;
        transition: all 0.3s ease;
      }
      .icon-btn:hover {
        transform: scale(1.2);
      }
      .sound-icon {
        color: #4caf50;
      }
      .pause-icon {
        color: #ffc107;
      }
      .help-icon {
        color: #9c27b0;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #fc813f;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Footer & BG Button --- */
      footer {
        text-align: center;
        padding: 5px;
        background: rgba(0, 0, 0, 0.4);
        font-size: 0.8rem;
        width: 100%;
        position: absolute;
        bottom: 0;
      }

      #change-bg-btn i {
        color: #a742f5;
      }

      #bg-selector-modal {
        z-index: 101;
      }

      .bg-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .bg-option {
        width: 100%;
        padding-top: 100%;
        border: 2px solid white;
        border-radius: 8px;
        cursor: pointer;
        background-size: cover;
        background-position: center;
        transition: transform 0.2s;
      }
      .bg-option:hover {
        transform: scale(1.05);
      }
      .bg-option.active {
        border-color: #f6fc3f;
        box-shadow: 0 0 10px #f6fc3f;
      }

      @media screen and (max-width: 420px) {
        .top-bar {
          justify-content: center;
        }
        .game-stats {
          order: 1;
          flex-basis: 100%;
          justify-content: center;
        }
        .sound-controls {
          order: 2;
        }
        .game-buttons {
          order: 3;
        }
        #volumeSlider {
          width: 80px;
        }
        .start-screen-content,
        .modal-content {
          padding: 20px;
        }
        .start-screen-content h1 {
          font-size: 2rem;
        }
        .start-screen-content p {
          font-size: 1rem;
        }
      }

      @media screen and (max-width: 325px) {
        .grid-item-content img {
          width: 30px;
          height: 30px;
        }
        #volumeSlider {
          width: 60px;
        }
        .btn {
          padding: 8px 12px;
          font-size: 1rem;
        }
      }

      #time-up-modal .modal-content {
        background: rgba(150, 0, 0, 0.8);
      }
    </style>
  </head>

  <body>
    <div class="game-wrapper">
      <div id="start-screen" class="overlay-screen">
        <div class="start-screen-content">
          <h1>PAIR CUTE</h1>
          <p>ANIMAL PICTURES</p>
          <div class="start-buttons">
            <button id="start-btn" class="btn">Mulai</button>
            <button id="info-btn" class="btn">Informasi</button>
          </div>
        </div>
      </div>

      <div id="info-modal" class="modal overlay-screen">
        <div class="modal-content">
          <span class="close-btn" data-modal="info-modal">&times;</span>
          <h2>Informasi Game</h2>

          <p>
            Hubungkan dua gambar hewan yang sama untuk menghilangkannya. Garis
            penghubung tidak boleh berbelok lebih dari dua kali. Dan kamu akan
            mendapat +5 poin.
            <strong
              >Setiap kesalahan menghubungkan akan mengurangi 2 poin.</strong
            >
          </p>

          <p style="margin-top: 15px">
            Game ini memiliki 3 level dengan tema berbeda:
            <strong>Level 1 (Hewan Darat)</strong>,
            <strong>Level 2 (Hewan Laut)</strong>, dan
            <strong>Level 3 (Hewan Udara)</strong>.
          </p>

          <div
            style="
              text-align: left;
              max-width: 300px;
              margin: 20px auto 0 auto;
              padding-left: 10px;
            "
          >
            <p><strong>Fitur Bantuan:</strong></p>
            <ul
              style="
                list-style-position: inside;
                padding-left: 5px;
                margin-top: 5px;
              "
            >
              <li>
                <strong
                  >Bintang (<i class="fas fa-star help-icon"></i>):</strong
                >
                Menunjukkan pasangan (biaya 2 poin).
              </li>
              <li style="margin-top: 5px">
                <strong>Jurus Spesial:</strong> Muncul saat buntu untuk
                menghubungkan pasangan sulit (biaya 3 poin).
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div id="pause-modal" class="modal overlay-screen">
        <div class="modal-content">
          <span class="close-btn" data-modal="pause-modal">&times;</span>
          <h2 id="pause-title">Game Dijeda</h2>
          <div id="fact-text">
            <div class="loader"></div>
            <p>Memuat fakta unik...</p>
          </div>
          <div class="modal-buttons">
            <button id="resume-game-btn" class="btn btn-confirm-yes">
              <i class="fas fa-play"></i> Lanjutkan
            </button>
          </div>
        </div>
      </div>

      <div id="confirm-help-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2>Gunakan Bantuan?</h2>
          <p>
            Apakah Anda yakin ingin menggunakan bantuan? Poin Anda akan
            berkurang 2.
          </p>
          <div class="modal-buttons">
            <button id="confirm-help-yes" class="btn btn-confirm-yes">
              Ya, Bantu
            </button>
            <button id="confirm-help-no" class="btn btn-confirm-no">
              Batal
            </button>
          </div>
        </div>
      </div>

      <div id="no-points-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2>Poin Tidak Cukup</h2>
          <p>
            Poin Anda tidak cukup untuk menggunakan bantuan. Anda membutuhkan
            minimal 2 poin.
          </p>
          <div class="modal-buttons">
            <button id="close-no-points" class="btn btn-confirm-yes">
              Mengerti
            </button>
          </div>
        </div>
      </div>

      <div id="level-complete-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2 id="level-complete-title">Level Selesai!</h2>
          <p id="level-complete-text">
            Anda telah menyelesaikan level ini dengan sukses!
          </p>
          <div class="modal-buttons">
            <!-- KETERANGAN: Menambahkan tombol bagikan -->
            <button id="share-level-btn" class="btn btn-share">
              <i class="fas fa-share-alt"></i> Bagikan
            </button>
            <button id="replay-level-btn" class="btn btn-confirm-no">
              <i class="fas fa-redo"></i> Main Lagi
            </button>
            <button id="next-level-btn" class="btn btn-confirm-yes">
              <i class="fas fa-arrow-right"></i> Lanjutkan
            </button>
          </div>
        </div>
      </div>

      <div id="game-complete-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2>Selamat!</h2>
          <p id="game-complete-text">Anda telah menyelesaikan semua level!</p>
          <div class="modal-buttons">
            <!-- KETERANGAN: Menambahkan tombol bagikan -->
            <button id="share-game-btn" class="btn btn-share">
              <i class="fas fa-share-alt"></i> Bagikan
            </button>
            <button id="play-again-btn" class="btn btn-confirm-yes">
              <i class="fas fa-redo"></i> Main Lagi
            </button>
          </div>
        </div>
      </div>

      <div id="time-up-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2>Waktu Habis!</h2>
          <p id="timeout-text">Jangan menyerah, coba lagi!</p>
          <div class="modal-buttons">
            <!-- KETERANGAN: Menambahkan tombol bagikan -->
            <button id="share-timeup-btn" class="btn btn-share">
              <i class="fas fa-share-alt"></i> Bagikan
            </button>
            <button id="play-again-timeup-btn" class="btn btn-confirm-yes">
              <i class="fas fa-redo"></i> Main Lagi
            </button>
          </div>
        </div>
      </div>

      <div id="bg-selector-modal" class="overlay-screen">
        <div class="modal-content">
          <span class="close-btn" data-modal="bg-selector-modal">&times;</span>
          <h2>Pilih Background</h2>
          <div class="bg-options">
            <!-- Opsi background akan ditambahkan di sini oleh JavaScript -->
          </div>
        </div>
      </div>

      <div id="super-move-modal" class="modal overlay-screen">
        <div class="modal-content">
          <h2>Tidak Ada Langkah!</h2>
          <p>
            Semua langkah biasa sudah habis. Aktifkan
            <strong>Jurus Spesial</strong> untuk menghubungkan satu pasangan
            sulit (dengan 3 belokan)?
          </p>
          <div class="modal-buttons">
            <button id="activate-super-move-no" class="btn btn-confirm-no">
              Tidak, Acak Papan
            </button>
            <button id="activate-super-move-yes" class="btn btn-confirm-yes">
              Ya, Aktifkan Jurus
            </button>
          </div>
        </div>
      </div>

      <div id="super-move-active-notice" class="modal overlay-screen">
        <div
          class="modal-content"
          style="border-color: #9c27b0; box-shadow: 0 0 15px #9c27b0"
        >
          <h2 style="color: #9c27b0">Jurus Spesial Aktif!</h2>
          <p>Pilih satu pasangan gambar yang sulit untuk dihubungkan.</p>
        </div>
      </div>

      <!-- KETERANGAN: Elemen ini digunakan untuk membuat gambar yang akan dibagikan -->
      <div
        id="screenshot-container"
        style="
          position: absolute;
          left: -9999px;
          top: 0;
          background: #2c3e50;
          color: white;
          padding: 20px;
          border-radius: 10px;
          width: 350px;
          text-align: center;
        "
      >
        <h1
          style="color: #f6fc3f; font-family: 'Times New Roman', Times, serif"
        >
          PAIR CUTE ANIMALS
        </h1>
        <h2 id="screenshot-title" style="color: #fc813f; margin-top: 10px"></h2>
        <p id="screenshot-text" style="font-size: 1.2rem; margin-top: 15px"></p>
        <p style="margin-top: 20px; font-size: 0.8rem">Mainkan di sini!</p>
      </div>

      <div class="container">
        <div class="judul">
          <h1 id="theme-title">HEWAN DARAT</h1>
        </div>
        <div class="top-bar">
          <div class="sound-controls">
            <button id="toggleSound" class="btn">
              <i class="fas fa-volume-up sound-icon icon-btn"></i>
            </button>
            <input
              id="volumeSlider"
              type="range"
              min="0"
              max="1"
              step="0.1"
              value="0.5"
              class="slider"
            />
          </div>
          <div class="game-stats">
            <div class="time">0:00</div>
            <div class="score-display" id="score-display">Poin: 0</div>
            <div id="level-display">Level 1</div>
          </div>
          <div class="game-buttons">
            <button id="change-bg-btn" class="btn" title="Ganti Background">
              <i class="fas fa-image icon-btn"></i>
            </button>
            <button id="help" class="btn" title="Bantuan (kurangi 2 poin)">
              <i class="fas fa-star help-icon icon-btn"></i>
            </button>
            <button id="pause" class="btn" title="Jeda">
              <i class="fas fa-pause pause-icon icon-btn"></i>
            </button>
          </div>
        </div>

        <div class="grid-container"></div>
      </div>

      <audio
        id="gameSound"
        src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"
        loop
      ></audio>
      <audio id="correctSound" class="game-sound" src="spx/benar.mp3"></audio>
      <audio id="wrongSound" class="game-sound" src="spx/salah.mp3"></audio>
      <audio
        id="winLevelSound"
        class="game-sound"
        src="spx/winlevel1.mp3"
      ></audio>
      <audio
        id="winGameSound"
        class="game-sound"
        src="spx/winsound.mp3"
      ></audio>
      <audio
        id="timeUpSound"
        class="game-sound"
        src="spx/waktu habis.mp3"
      ></audio>
      <audio
        id="tenSecondsSound"
        class="game-sound"
        src="spx/waktu 10 detik.mp3"
        loop
      ></audio>

      <footer>@Copyright by Riyan 2025</footer>
    </div>

    <script>
      // --- Global State & Level Configurations ---
      var currentLevel = 1;
      var totalLevels = 3;
      var isPaused = false;
      var score = 0;
      var helpUsed = false;
      var timerInterval;
      var countdownSoundPlayed = false;
      var isMuted = false; // <<< TAMBAHKAN BARIS INI
      var isSuperMoveActive = false; // <<< TAMBAHKAN BARIS INI

      const levelConfigs = {
        1: {
          row: 8,
          col: 7,
          objectCount: 14,
          time: 180,
          theme: "Hewan Darat",
          imgPrefix: "hewan_darat/",
        },
        2: {
          row: 8,
          col: 8,
          objectCount: 16,
          time: 150,
          theme: "Hewan Laut",
          imgPrefix: "hewan_laut/",
        },
        3: {
          row: 9,
          col: 8,
          objectCount: 18,
          time: 120,
          theme: "Hewan Udara",
          imgPrefix: "hewan_udara/",
        },
      };

      const defaultFacts = {
        "Hewan Darat": "Kulit harimau juga bergaris, sama seperti bulunya.",
        "Hewan Laut": "Gurita memiliki tiga jantung.",
        "Hewan Udara": "Burung kolibri bisa terbang mundur.",
      };

      // --- config.js ---
      var config = (function () {
        var itemDirectionHTML = ` <div class="grid-item-direction"><div class="y up"></div><div class="y down"></div><div class="x left"></div><div class="x right"></div></div>`;
        var baseConfig = {
          imgUrl: "./img/",
          imgExtension: ".png",
          imgByName: function (name) {
            var src =
              this.imgUrl + this.levelImgPrefix + name + this.imgExtension;
            return `<img draggable="false" src="${src}"></img>`;
          },
          itemDirectionHTML: itemDirectionHTML,
        };
        function loadLevelConfig(level) {
          const levelData = levelConfigs[level];
          this.row = levelData.row;
          this.col = levelData.col;
          this.objectCount = levelData.objectCount;
          this.repeatCount =
            (levelData.row * levelData.col) / levelData.objectCount;
          this.time = levelData.time;
          this.theme = levelData.theme;
          this.levelImgPrefix = levelData.imgPrefix;
        }
        baseConfig.loadLevelConfig = loadLevelConfig;
        return baseConfig;
      })();

      // --- util.js & Sound Functions ---
      var log = console.log.bind(console);
      var $ = (elem) => document.querySelectorAll(elem);
      var random = function (start, end) {
        return Math.floor(Math.random() * (end - start + 1)) + start;
      };
      var on = function (elem, type, callback, status) {
        elem.addEventListener(type, (e) => {
          callback(e);
          if (status) return false;
        });
      };
      var reduceDimension = (arr) => Array.prototype.concat.apply([], arr);

      function playSound(soundId) {
        const sound = document.getElementById(soundId);
        if (sound && sound.readyState >= 2) {
          sound.currentTime = 0;
          sound
            .play()
            .catch((e) => console.error(`Could not play sound: ${soundId}`, e));
        }
      }
      function stopSound(soundId) {
        const sound = document.getElementById(soundId);
        if (sound) {
          sound.pause();
          sound.currentTime = 0;
        }
      }

      // --- view.js ---
      var View = (function () {
        var gridContainer = $(".grid-container")[0];
        var timeDom = $(".time")[0];
        var levelDisplay = $("#level-display")[0];
        var themeTitle = $("#theme-title")[0];
        var scoreDisplay = $("#score-display")[0];
        var game = null;
        var View = function () {};

        View.prototype = {
          init: function (g, data) {
            game = g;
            this.updateTime(data.time);
            this.updateLevelDisplay();
            this.updateScore();
            this.initGrid(data.cell);
          },
          updateTime: function (time) {
            var minutes = Math.floor(time / 60);
            var seconds = time % 60;
            timeDom.innerHTML = `${minutes}:${
              seconds < 10 ? "0" : ""
            }${seconds}`;
          },
          updateLevelDisplay: function () {
            levelDisplay.innerText = `Level ${currentLevel}`;
            themeTitle.innerText = config.theme.toUpperCase();
          },
          updateScore: function () {
            scoreDisplay.innerText = `Poin: ${score}`;
          },
          itemHTML: function (el) {
            var empty = el.val === null;
            var img = config.imgByName(empty ? 0 : el.val);
            return `<div class="grid-item ${empty ? "hidden" : ""}" data-val="${
              el.val
            }" data-index="${
              el.index
            }"><div class="grid-item-content">${img}</div>${
              config.itemDirectionHTML
            }</div>`;
          },
          initGrid: function (cell) {
            var html = "";
            cell.forEach((arr) => {
              html += "<div class='grid-cell'>";
              arr.forEach((el) => {
                html += this.itemHTML(el);
              });
              html += "</div>";
            });
            gridContainer.innerHTML = html;
          },
          itemAction: (item) => item.classList.add("action"),
          itemCancelAction: (item) => item.classList.remove("action"),
          removeItem: function (index) {
            $(`.grid-item[data-index="${index}"]`)[0].classList.add("hidden");
          },
          getRelationship: function (prev, next, current) {
            var dir = [];
            var max = [prev > current, next > current];
            var arr = [prev, next];
            arr.forEach(function (el, index) {
              if (game.identicalY(el, current))
                dir[index] = max[index] ? "right" : "left";
              else if (game.identicalX(el, current))
                dir[index] = max[index] ? "down" : "up";
            });
            return dir;
          },
          showLine: function (pos, callback) {
            var _this = this;
            pos.forEach(function (el, index) {
              if (index === 0 || index === pos.length - 1) return;
              var item = $(
                `.grid-item[data-index="${el}"] .grid-item-direction`
              )[0];
              var prev = pos[index - 1];
              var next = pos[index + 1];
              var dir = _this.getRelationship(prev, next, el);
              item.classList.add(dir[0], dir[1]);
            });
            setTimeout(() => {
              _this.clearLine();
              callback();
            }, 300);
          },
          clearLine: function () {
            $(".grid-item-direction").forEach((el) => {
              el.className = "grid-item-direction";
            });
          },
        };
        return View;
      })();

      // --- game.js ---
      var Game = (function () {
        var ROW, COL, itemCount;
        var data = { time: 0, cell: [] };
        var hlepData = [];

        var Game = function () {};

        Game.prototype = {
          setup: function (level) {
            stopSound("tenSecondsSound");
            countdownSoundPlayed = false;
            currentLevel = level;
            config.loadLevelConfig(currentLevel);
            ROW = config.row + 2;
            COL = config.col + 2;
            itemCount = config.row * config.col;
            data.time = config.time;
            this.view = new View();
            this.init();
          },
          init: function () {
            this.start();
            this.view.init(this, data);
            this.startTimer();
          },
          start: function () {
            this.initCell();
            this.fillCell();
            this.checkDeadlock();
          },
          restartCurrentLevel: function () {
            clearInterval(timerInterval);
            this.setup(currentLevel);
          },
          help: function () {
            if (isPaused) return;
            if (score >= 2) {
              $("#confirm-help-modal")[0].style.display = "flex";
            } else {
              $("#no-points-modal")[0].style.display = "flex";
            }
          },
          executeHelp: function () {
            helpUsed = true;
            // Kurangi poin untuk mencoba menggunakan bantuan
            score -= 2;
            this.view.updateScore();

            if (hlepData.length >= 2) {
              // JIKA PASANGAN DITEMUKAN:
              // Poin tetap terpotong, dan bantuan akan menunjukkan pasangan.
              this.judge.apply(this, hlepData);
            } else {
              // JIKA TIDAK ADA PASANGAN (DEADLOCK):
              // 1. Bantuan gagal, maka kembalikan poin yang tadi dipotong.
              score += 2;
              this.view.updateScore();
              this.ui.confirmHelpModal.style.display = "none";

              // 2. Alih-alih menampilkan alert, tampilkan modal "Jurus Spesial".
              // Tutup dulu modal konfirmasi bantuan jika masih terbuka.
              $("#confirm-help-modal")[0].style.display = "none";
              // Tampilkan modal jurus spesial
              this.ui.superMoveModal.style.display = "flex";
            }
          },
          startTimer: function () {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
              if (!isPaused) {
                data.time--;
                if (data.time <= 20 && !countdownSoundPlayed) {
                  playSound("tenSecondsSound");
                  countdownSoundPlayed = true;
                }
                this.view.updateTime(data.time);
                if (data.time <= 0) {
                  this.over();
                }
              }
            }, 1000);
          },
          initCell: function () {
            var index = -1;
            data.cell = [];
            for (var i = 0; i < ROW; i++) {
              data.cell[i] = [];
              for (var j = 0; j < COL; j++) {
                index++;
                data.cell[i][j] = { val: null, index: index };
              }
            }
          },
          fillCell: function () {
            var count = config.objectCount;
            var repeat = config.repeatCount;
            var items = [];
            for (var i = 1; i <= count; i++) {
              for (var j = 0; j < repeat; j++) {
                items.push(i);
              }
            }
            items = this.shuffleArray(items);
            var k = 0;
            for (var y = 1; y <= config.row; y++) {
              for (var x = 1; x <= config.col; x++) {
                data.cell[y][x].val = items[k];
                data.cell[y][x].index = this.posToIndex({ x, y });
                k++;
              }
            }
          },
          shuffleArray: function (array) {
            for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
          },
          indexToPos: (index) => ({
            x: index % COL,
            y: Math.floor(index / COL),
          }),
          posToIndex: (obj) => obj.y * COL + obj.x,
          removeItem: function (before, after) {
            this.getItem(before).val = null;
            this.getItem(after).val = null;
            this.view.removeItem(before);
            this.view.removeItem(after);
            itemCount -= 2;
            if (!helpUsed) {
              playSound("correctSound");
              score += 5;
              this.view.updateScore();
            }
            helpUsed = false;
            this.checkWinning();
          },
          isEmpty: (obj) => obj.val === null,
          isSame: function (b, a) {
            return this.getItem(b).val === this.getItem(a).val;
          },
          identicalX: function (b, a) {
            return this.indexToPos(b).x === this.indexToPos(a).x;
          },
          identicalY: function (b, a) {
            return this.indexToPos(b).y === this.indexToPos(a).y;
          },
          getAround: () => [-COL, COL, -1, 1],
          getCorner: function (before, after) {
            var min = this.indexToPos(Math.min(before, after));
            var max = this.indexToPos(Math.max(before, after));
            return [
              this.posToIndex({ x: max.x, y: min.y }),
              this.posToIndex({ x: min.x, y: max.y }),
            ];
          },
          connectable: function (before, after) {
            var _this = this,
              pos = [],
              success = false,
              min = Math.min(before, after),
              max = Math.max(before, after);
            var called = function (dir) {
              var i = min,
                num = dir === "x" ? COL : 1;
              while ((i += num) < max) {
                var current = _this.getItem(i);
                if (_this.isEmpty(current)) pos.push(current.index);
                else {
                  pos = [];
                  return;
                }
              }
              if (_this.getItem(i) === _this.getItem(max)) success = true;
            };
            if (this.identicalY(before, after)) called("y");
            else if (this.identicalX(before, after)) called("x");
            if (success && min !== before) pos = pos.reverse();
            return { success: success, pos: pos };
          },
          directlyConnectable: function (b, a) {
            return this.connectable(b, a);
          },
          onceCorner: function (before, after) {
            var _this = this,
              success = false,
              pos = [],
              corners = this.getCorner(before, after);
            corners.forEach(function (el) {
              if (!_this.isEmpty(_this.getItem(el)) || success) return;
              var s = [
                _this.connectable(before, el),
                _this.connectable(el, after),
              ];
              if (s.every((st) => st.success)) {
                s[0].pos.push(el);
                success = true;
                pos = s[0].pos.concat(s[1].pos);
              }
            });
            return { success: success, pos: pos };
          },
          twiceCorner: function (before, after) {
            var success = false,
              pos = [],
              arounds = this.getAround();
            call: for (var i = 0; i < arounds.length; i++) {
              var j = before;
              while ((j = this.getNext(j, arounds[i])) !== -1) {
                if (!this.isEmpty(this.getItem(j))) break;
                var _status = this.onceCorner(j, after);
                if (_status.success) {
                  success = true;
                  var _pos = this.connectable(before, j).pos;
                  _pos.push(j);
                  pos = _pos.concat(_status.pos);
                  break call;
                }
              }
            }
            return { success: success, pos: pos };
          },
          // --- LETAKKAN SETELAH FUNGSI twiceCorner ---
          thriceCorner: function (before, after) {
            var success = false,
              pos = [],
              arounds = this.getAround();
            call: for (var i = 0; i < arounds.length; i++) {
              var j = before;
              while ((j = this.getNext(j, arounds[i])) !== -1) {
                if (!this.isEmpty(this.getItem(j))) break;
                // Coba cari koneksi dengan 2 belokan dari titik perantara (j)
                var _status = this.twiceCorner(j, after); // Perbedaannya ada di sini
                if (_status.success) {
                  success = true;
                  var _pos = this.connectable(before, j).pos;
                  _pos.push(j);
                  pos = _pos.concat(_status.pos);
                  break call;
                }
              }
            }
            return { success: success, pos: pos };
          },
          getNext: function (index, direction) {
            var pos = this.indexToPos(index);
            if (
              (direction === -1 && pos.x === 0) ||
              (direction === 1 && pos.x === COL - 1)
            )
              return -1;
            var nextIndex = index + direction;
            if (this.isOutside(nextIndex)) return -1;
            return nextIndex;
          },
          // GANTI FUNGSI isConnectable LAMA DENGAN INI
          isConnectable: function (before, after) {
            if (isPaused) return false;
            var status = {};
            if (before === after || !this.isSame(before, after)) return false;

            var calleds = [
              this.directlyConnectable,
              this.onceCorner,
              this.twiceCorner,
            ];

            // Jika Jurus Spesial aktif, tambahkan logika 3 belokan ke dalam pengecekan
            // Kode Baru di dalam fungsi judge
            if (isSuperMoveActive) {
              isSuperMoveActive = false;
              console.log("Jurus Spesial digunakan! Poin dikurangi 3.");

              // Kurangi skor sebanyak 3 poin
              score -= 3;
              // Pastikan skor tidak menjadi minus
              if (score < 0) score = 0;
              // Perbarui tampilan skor
              this.view.updateScore();
            }

            for (var i = 0; i < calleds.length; i++) {
              status = calleds[i].bind(this)(before, after);
              if (status.success) break;
            }
            return status;
          },

          // GANTI FUNGSI judge LAMA DENGAN INI
          judge: function (before, after) {
            var _this = this;
            var status = this.isConnectable(before, after);
            if (status && status.success) {
              // Nonaktifkan kembali Jurus Spesial setelah berhasil digunakan
              if (isSuperMoveActive) {
                isSuperMoveActive = false;
                console.log("Jurus Spesial digunakan!");
                // Di sini Anda bisa menambahkan logika lain,
                // misalnya mengurangi skor sebagai biaya penggunaan jurus.
              }

              status.pos.unshift(before);
              status.pos.push(after);
              this.view.showLine(status.pos, () =>
                _this.removeItem(before, after)
              );
              return true;
            }
            return false;
          },
          isOutside: function (index) {
            var pos = this.indexToPos(index);
            return pos.x < 0 || pos.y < 0 || pos.x > COL - 1 || pos.y > ROW - 1;
          },
          getItem: function (index) {
            if (this.isOutside(index)) return {};
            var pos = this.indexToPos(index);
            return data.cell[pos.y][pos.x];
          },
          winning: function () {
            clearInterval(timerInterval);
            stopSound("tenSecondsSound");
            if (currentLevel < totalLevels) {
              playSound("winLevelSound");
              $("#level-complete-modal")[0].style.display = "flex";
            } else {
              playSound("winGameSound");
              $(
                "#game-complete-text"
              )[0].innerText = `Anda telah menyelesaikan semua level dengan total poin ${score}!`;
              $("#game-complete-modal")[0].style.display = "flex";
            }
          },
          over: function () {
            clearInterval(timerInterval);
            stopSound("tenSecondsSound");
            playSound("timeUpSound");
            $(
              "#timeout-text"
            )[0].innerText = `Yahh gagal! Waktu habis. Total poin Anda: ${score}. Coba lagi?`;
            $("#time-up-modal")[0].style.display = "flex";
          },
          checkWinning: function () {
            if (itemCount === 0) this.winning();
            else this.checkDeadlock();
          },
          // --- GANTI FUNGSI LAMA DENGAN INI ---
          checkDeadlock: function () {
            hlepData = [];
            var cell = reduceDimension(data.cell);
            var filter = (i) => cell.filter((el) => el.val === i);
            for (var i = 1; i <= config.objectCount; i++) {
              var result = filter(i);
              for (var j = 0; j < result.length; j++) {
                for (var k = j + 1; k < result.length; k++) {
                  if (
                    this.isConnectable(result[j].index, result[k].index).success
                  ) {
                    hlepData = [result[j].index, result[k].index];
                    return; // Ditemukan langkah, keluar dari fungsi
                  }
                }
              }
            }
            // Jika loop selesai dan hlepData masih kosong, berarti deadlock
            // Tampilkan modal Jurus Spesial, JANGAN panggil randomReset
            this.ui.superMoveModal.style.display = "flex";
          },

          // --- UBAH JUGA FUNGSI INI ---
          randomReset: function () {
            // Fungsi ini sekarang hanya berisi logika untuk mengacak ulang,
            // tanpa alert atau notifikasi.
            this.fillCell();
            this.view.init(this, data);
            this.checkDeadlock(); // Cek lagi setelah diacak
          },
          getAnimalFact: async function (theme) {
            const factTextElement = $("#fact-text")[0];
            factTextElement.innerHTML = `<div class="loader"></div><p>Memuat fakta unik...</p>`;
            try {
              let chatHistory = [
                {
                  role: "user",
                  parts: [
                    {
                      text: `Beri aku satu fakta unik dan singkat tentang dunia ${theme} dalam bahasa Indonesia.`,
                    },
                  ],
                },
              ];
              const payload = { contents: chatHistory };
              const apiKey = "AIzaSyDrVTUfdsdlQ5YnVcAzRYhQa-yj2WyBEp4";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
              const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                throw new Error(
                  "API request failed with status: " + response.status
                );
              }
              const result = await response.json();
              if (
                result.candidates &&
                result.candidates.length > 0 &&
                result.candidates[0].content &&
                result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0
              ) {
                const text = result.candidates[0].content.parts[0].text;
                factTextElement.innerHTML = `<p>${text}</p>`;
              } else {
                throw new Error("Invalid API response format");
              }
            } catch (error) {
              console.error(
                "Could not fetch fact from API, using fallback.",
                error
              );
              factTextElement.innerHTML = `<p>${
                defaultFacts[theme] ||
                "Setiap hewan itu unik dengan caranya sendiri."
              }</p>`;
            }
          },
        };
        return Game;
      })();

      // --- event.js and main.js ---
      window.addEventListener("load", function () {
        const game = new Game();
        const ui = {
          startScreen: $("#start-screen")[0],
          gameContainer: $(".container")[0],
          startBtn: $("#start-btn")[0],
          infoBtn: $("#info-btn")[0],
          infoModal: $("#info-modal")[0],
          pauseModal: $("#pause-modal")[0],
          confirmHelpModal: $("#confirm-help-modal")[0],
          noPointsModal: $("#no-points-modal")[0],
          levelCompleteModal: $("#level-complete-modal")[0],
          gameCompleteModal: $("#game-complete-modal")[0],
          timeUpModal: $("#time-up-modal")[0],
          bgSelectorModal: $("#bg-selector-modal")[0],
          changeBgBtn: $("#change-bg-btn")[0],
          bgOptionsContainer: $("#bg-selector-modal .bg-options")[0],
          closeBtns: $(".close-btn"),
          confirmHelpYesBtn: $("#confirm-help-yes")[0],
          confirmHelpNoBtn: $("#confirm-help-no")[0],
          closeNoPointsBtn: $("#close-no-points")[0],
          resumeGameBtn: $("#resume-game-btn")[0],
          replayLevelBtn: $("#replay-level-btn")[0],
          nextLevelBtn: $("#next-level-btn")[0],
          playAgainBtn: $("#play-again-btn")[0],
          playAgainTimeUpBtn: $("#play-again-timeup-btn")[0],
          shareLevelBtn: $("#share-level-btn")[0],
          shareGameBtn: $("#share-game-btn")[0],
          shareTimeUpBtn: $("#share-timeup-btn")[0],
          gridContainer: $(".grid-container")[0],
          helpBtn: $("#help")[0],
          pauseBtn: $("#pause")[0],
          gameSound: $("#gameSound")[0],
          toggleSoundBtn: $("#toggleSound")[0],
          volumeSlider: $("#volumeSlider")[0],
          allSounds: document.querySelectorAll("audio"), // <<< TAMBAHKAN BARIS INI
          reshuffleNoticeModal: $("#reshuffle-notice-modal")[0],
          superMoveModal: $("#super-move-modal")[0], // <<< TAMBAHKAN
          activateSuperMoveYesBtn: $("#activate-super-move-yes")[0], // <<< TAMBAHKAN
          activateSuperMoveNoBtn: $("#activate-super-move-no")[0], // <<< TAMBAHKAN
          superMoveActiveNotice: $("#super-move-active-notice")[0], // <<< TAMBAHKAN BARIS INI
        };
        game.ui = ui; // <<< TAMBAHKAN BARIS INI

        // Background Options
        const backgrounds = [
          "bg/bg1.png",
          "bg/bg2.png",
          "bg/bg3.png",
          "bg/bg4.png",
          "bg/bg5.png",
          "bg/bg6.png",
        ];

        function changeBackground(bgValue) {
          document.body.style.backgroundImage = `url('${bgValue}')`;
          localStorage.setItem("gameBackground", bgValue);
          const allOptions = document.querySelectorAll(".bg-option");
          allOptions.forEach((opt) => {
            if (opt.style.backgroundImage.includes(bgValue)) {
              opt.classList.add("active");
            } else {
              opt.classList.remove("active");
            }
          });
        }

        function populateBackgroundOptions() {
          let optionsHTML = "";
          backgrounds.forEach((bg) => {
            optionsHTML += `<div class="bg-option" style="background-image: url('${bg}')" data-bg="${bg}"></div>`;
          });
          ui.bgOptionsContainer.innerHTML = optionsHTML;

          const bgOptions = document.querySelectorAll(".bg-option");
          bgOptions.forEach((option) => {
            on(option, "click", (e) => {
              const bg = e.target.getAttribute("data-bg");
              changeBackground(bg);
            });
          });
        }

        function loadSavedBackground() {
          const savedBg = localStorage.getItem("gameBackground");
          if (savedBg) {
            changeBackground(savedBg);
          } else {
            changeBackground(backgrounds[0]);
          }
        }

        // KETERANGAN: Fungsi untuk menangani proses berbagi gambar
        async function handleShare(title, text) {
          const element = document.getElementById("screenshot-container");
          document.getElementById("screenshot-title").innerText = title;
          document.getElementById("screenshot-text").innerText = text;

          try {
            const canvas = await html2canvas(element, { useCORS: true });
            canvas.toBlob(async (blob) => {
              if (navigator.share) {
                const file = new File([blob], "hasil-game.png", {
                  type: "image/png",
                });
                await navigator
                  .share({
                    title: "Lihat Hasil Game Saya!",
                    text: text,
                    files: [file],
                  })
                  .catch((err) => {
                    if (err.name !== "AbortError") throw err;
                  });
              } else {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "hasil-game.png";
                link.click();
                URL.revokeObjectURL(link.href);
              }
            }, "image/png");
          } catch (err) {
            console.error("Error sharing:", err);
            alert("Gagal membagikan gambar.");
          }
        }

        on(ui.changeBgBtn, "click", () => {
          ui.bgSelectorModal.style.display = "flex";
        });

        // --- TAMBAHKAN EVENT LISTENER INI ---
        on(ui.activateSuperMoveYesBtn, "click", () => {
          // Sembunyikan modal pilihan
          ui.superMoveModal.style.display = "none";
          // Aktifkan status jurus spesial
          isSuperMoveActive = true;

          // Tampilkan notifikasi bahwa jurus aktif
          ui.superMoveActiveNotice.style.display = "flex";

          // Sembunyikan notifikasi secara otomatis setelah 2.5 detik
          setTimeout(() => {
            ui.superMoveActiveNotice.style.display = "none";
          }, 2500);
        });

        on(ui.activateSuperMoveNoBtn, "click", () => {
          ui.superMoveModal.style.display = "none";
          // Jika pemain menolak, panggil fungsi acak ulang papan.
          game.randomReset();
        });

        on(ui.startBtn, "click", function () {
          ui.startScreen.style.display = "none";
          ui.gameContainer.style.display = "flex";
          ui.gameSound.volume = 0.5;
          ui.gameSound
            .play()
            .catch((e) => console.log("Audio play failed:", e));
          game.setup(1);
          eventListeners(game);
        });

        on(ui.infoBtn, "click", () => {
          ui.infoModal.style.display = "flex";
        });

        ui.closeBtns.forEach((btn) => {
          on(btn, "click", (e) => {
            const modal = btn.closest(".overlay-screen");
            if (modal) modal.style.display = "none";
            if (modal.id === "pause-modal" && isPaused) {
              togglePause(game);
            }
          });
        });

        on(ui.confirmHelpYesBtn, "click", () => {
          ui.confirmHelpModal.style.display = "none";
          game.executeHelp();
        });
        on(ui.confirmHelpNoBtn, "click", () => {
          ui.confirmHelpModal.style.display = "none";
        });
        on(ui.closeNoPointsBtn, "click", () => {
          ui.noPointsModal.style.display = "none";
        });
        on(ui.resumeGameBtn, "click", () => togglePause(game));
        on(ui.playAgainTimeUpBtn, "click", () => {
          ui.timeUpModal.style.display = "none";
          game.restartCurrentLevel(); // <--- UBAH MENJADI INI
        });

        on(ui.shareTimeUpBtn, "click", () => {
          handleShare(
            "Waktu Habis!",
            `Permainanku berakhir dengan Poin ${score}. Ayo coba lagi!`
          );
        });
        on(ui.replayLevelBtn, "click", () => {
          ui.levelCompleteModal.style.display = "none";
          game.restartCurrentLevel();
        });
        on(ui.nextLevelBtn, "click", () => {
          ui.levelCompleteModal.style.display = "none";
          game.setup(currentLevel + 1);
        });
        on(ui.playAgainBtn, "click", () => {
          location.reload();
        });

        // KETERANGAN: Event listener untuk tombol-tombol bagikan yang baru
        on(ui.shareLevelBtn, "click", () =>
          handleShare(
            `Level ${currentLevel} Selesai!`,
            `Aku berhasil menyelesaikan Level ${currentLevel} dengan Poin ${score}!`
          )
        );
        on(ui.shareGameBtn, "click", () =>
          handleShare(
            "Game Selesai!",
            `Aku berhasil menyelesaikan semua level dengan total Poin ${score}!`
          )
        );
        on(ui.shareTimeUpBtn, "click", () =>
          handleShare(
            "Waktu Habis!",
            `Permainanku berakhir dengan Poin ${score}. Ayo coba lagi!`
          )
        );

        function eventListeners(gameInstance) {
          var before = null;
          on(ui.gridContainer, "click", function (e) {
            if (isPaused) return;
            var target = e.target;
            if (target.tagName !== "IMG") return;
            var item = target.parentNode.parentNode;
            if (item.classList.contains("hidden")) return;
            if (before === item) {
              gameInstance.view.itemCancelAction(item);
              before = null;
              return;
            }
            gameInstance.view.itemAction(item);
            if (!before) {
              before = item;
              return;
            }
            var beforeIndex = parseInt(before.getAttribute("data-index"));
            var afterIndex = parseInt(item.getAttribute("data-index"));
            // Kode Baru
            if (!gameInstance.judge(beforeIndex, afterIndex)) {
              // Mainkan suara salah
              playSound("wrongSound");

              // Kurangi 2 poin untuk kesalahan
              score = Math.max(0, score - 2); // Math.max untuk memastikan skor tidak minus
              gameInstance.view.updateScore(); // Perbarui tampilan skor

              // Batalkan pilihan sebelumnya dan jadikan item ini pilihan baru
              gameInstance.view.itemCancelAction(before);
              before = item;
            } else {
              // Jika berhasil, reset pilihan
              before = null;
            }
          });
          on(ui.helpBtn, "click", () => gameInstance.help());
          on(ui.pauseBtn, "click", () => togglePause(gameInstance));
        }

        ui.gameSound.volume = ui.volumeSlider.value;
        on(ui.toggleSoundBtn, "click", toggleSound);
        on(ui.volumeSlider, "input", () => {
          const newVolume = ui.volumeSlider.value;
          // Terapkan volume ke semua elemen audio
          ui.allSounds.forEach((sound) => {
            sound.volume = newVolume;
          });

          // Jika volume > 0 dan sedang di-mute, maka unmute
          if (newVolume > 0 && isMuted) {
            toggleSound();
          }
          // Jika volume diatur ke 0 dan tidak sedang di-mute, maka mute
          else if (newVolume == 0 && !isMuted) {
            toggleSound();
          }
        });

        function toggleSound() {
          isMuted = !isMuted; // Balikkan status mute

          // Terapkan status .muted ke semua elemen audio
          ui.allSounds.forEach((sound) => {
            sound.muted = isMuted;
          });

          // Tangani ikon dan musik latar secara khusus
          if (isMuted) {
            ui.gameSound.pause(); // Selalu jeda musik latar saat mute
            ui.toggleSoundBtn.innerHTML =
              '<i class="fas fa-volume-mute sound-icon icon-btn"></i>';
          } else {
            // Jika game berjalan dan tidak dijeda, putar kembali musiknya
            if (ui.gameContainer.style.display === "flex" && !isPaused) {
              ui.gameSound
                .play()
                .catch((e) => console.log("Audio play failed:", e));
            }
            ui.toggleSoundBtn.innerHTML =
              '<i class="fas fa-volume-up sound-icon icon-btn"></i>';
          }
        }

        async function togglePause(gameInstance) {
          if (isPaused) {
            isPaused = false;
            ui.pauseBtn.innerHTML =
              '<i class="fas fa-pause pause-icon icon-btn"></i>';
            if (ui.toggleSoundBtn.innerHTML.includes("volume-up")) {
              ui.gameSound
                .play()
                .catch((e) => console.log("Audio play failed:", e));
            }
            if (countdownSoundPlayed) playSound("tenSecondsSound");
            gameInstance.startTimer();
            ui.pauseModal.style.display = "none";
          } else {
            isPaused = true;
            clearInterval(timerInterval);
            ui.pauseBtn.innerHTML =
              '<i class="fas fa-play pause-icon icon-btn"></i>';
            ui.gameSound.pause();
            stopSound("tenSecondsSound");
            $("#pause-title")[0].innerText = `Game Dijeda`;
            ui.pauseModal.style.display = "flex";
            await gameInstance.getAnimalFact(levelConfigs[currentLevel].theme);
          }
        }

        // Initialize Backgrounds
        populateBackgroundOptions();
        loadSavedBackground();
      });
    </script>
  </body>
</html>
